import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_ROOT = path.resolve(__dirname, '..');

const SOURCE_ROOT = path.join(PROJECT_ROOT, 'public', 'crystallizer', 'source');
const INPUT_DIR = path.join(SOURCE_ROOT, 'img');
const OUTPUT_FILE = path.join(PROJECT_ROOT, 'public', 'crystallizer', 'modules', 'sourceFiles.generated.js');

const IMAGE_EXT_PRIORITY = ['avif', 'webp', 'png', 'jpg', 'jpeg', 'gif'];
const IMAGE_EXT_SET = new Set(IMAGE_EXT_PRIORITY);

function extOf(filename) {
  const m = /\.([^.]+)$/.exec(filename);
  return (m ? m[1] : '').toLowerCase();
}

function stemOf(filename) {
  return filename.replace(/\.[^.]+$/, '');
}

async function walkFiles(dir) {
  const out = [];
  const dirents = await fs.readdir(dir, { withFileTypes: true });
  for (const d of dirents) {
    if (!d || !d.name || d.name.startsWith('.')) continue;
    const full = path.join(dir, d.name);
    if (d.isDirectory()) {
      out.push(...(await walkFiles(full)));
    } else if (d.isFile()) {
      out.push(full);
    }
  }
  return out;
}

function pickBetter(a, b) {
  // a/b: { name, ext }
  const ai = IMAGE_EXT_PRIORITY.indexOf(a.ext);
  const bi = IMAGE_EXT_PRIORITY.indexOf(b.ext);
  if (ai === -1 && bi === -1) return a;
  if (ai === -1) return b;
  if (bi === -1) return a;
  return ai <= bi ? a : b;
}

const filesAbs = await walkFiles(INPUT_DIR);
const candidates = filesAbs
  .map((abs) => path.relative(SOURCE_ROOT, abs).split(path.sep).join('/'))
  // BG pool は別管理
  .filter((rel) => !/^bg_/i.test(path.posix.basename(rel)))
  .filter((rel) => IMAGE_EXT_SET.has(extOf(rel)));

const byStem = new Map();
for (const name of candidates) {
  const ext = extOf(name);
  const stem = stemOf(path.posix.basename(name));
  const prev = byStem.get(stem);
  const next = { name, ext };
  byStem.set(stem, prev ? pickBetter(prev, next) : next);
}

const files = Array.from(byStem.values())
  .map((v) => v.name)
  .sort((a, b) => a.localeCompare(b, 'en', { numeric: true, sensitivity: 'base' }));

const header = `// AUTO-GENERATED FILE. DO NOT EDIT.\n// Generated by scripts/generate-crystalizer-source-files.mjs\n\n`;
const body = `export const SOURCE_FILES = [\n${files.map((f) => `  ${JSON.stringify(f)},`).join('\n')}\n];\n`;

await fs.mkdir(path.dirname(OUTPUT_FILE), { recursive: true });
await fs.writeFile(OUTPUT_FILE, header + body, 'utf8');

console.log(`[crystalizer] wrote ${files.length} SOURCE_FILES to ${path.relative(PROJECT_ROOT, OUTPUT_FILE)}`);
