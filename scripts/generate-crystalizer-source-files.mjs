import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_ROOT = path.resolve(__dirname, '..');

const INPUT_DIR = path.join(PROJECT_ROOT, 'public', 'crystalizer', 'source');
const OUTPUT_FILE = path.join(PROJECT_ROOT, 'public', 'crystalizer', 'modules', 'sourceFiles.generated.js');

const IMAGE_EXT_PRIORITY = ['avif', 'webp', 'png', 'jpg', 'jpeg', 'gif'];
const IMAGE_EXT_SET = new Set(IMAGE_EXT_PRIORITY);

function extOf(filename) {
  const m = /\.([^.]+)$/.exec(filename);
  return (m ? m[1] : '').toLowerCase();
}

function stemOf(filename) {
  return filename.replace(/\.[^.]+$/, '');
}

function pickBetter(a, b) {
  // a/b: { name, ext }
  const ai = IMAGE_EXT_PRIORITY.indexOf(a.ext);
  const bi = IMAGE_EXT_PRIORITY.indexOf(b.ext);
  if (ai === -1 && bi === -1) return a;
  if (ai === -1) return b;
  if (bi === -1) return a;
  return ai <= bi ? a : b;
}

const dirents = await fs.readdir(INPUT_DIR, { withFileTypes: true });

const candidates = dirents
  .filter((d) => d.isFile())
  .map((d) => d.name)
  .filter((name) => !name.startsWith('.'))
  // BG pool は別管理
  .filter((name) => !/^bg_/i.test(name))
  .filter((name) => IMAGE_EXT_SET.has(extOf(name)));

const byStem = new Map();
for (const name of candidates) {
  const ext = extOf(name);
  const stem = stemOf(name);
  const prev = byStem.get(stem);
  const next = { name, ext };
  byStem.set(stem, prev ? pickBetter(prev, next) : next);
}

const files = Array.from(byStem.values())
  .map((v) => v.name)
  .sort((a, b) => a.localeCompare(b, 'en', { numeric: true, sensitivity: 'base' }));

const header = `// AUTO-GENERATED FILE. DO NOT EDIT.\n// Generated by scripts/generate-crystalizer-source-files.mjs\n\n`;
const body = `export const SOURCE_FILES = [\n${files.map((f) => `  ${JSON.stringify(f)},`).join('\n')}\n];\n`;

await fs.mkdir(path.dirname(OUTPUT_FILE), { recursive: true });
await fs.writeFile(OUTPUT_FILE, header + body, 'utf8');

console.log(`[crystalizer] wrote ${files.length} SOURCE_FILES to ${path.relative(PROJECT_ROOT, OUTPUT_FILE)}`);
