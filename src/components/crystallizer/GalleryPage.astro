---
import Page from "@/layouts/Page.astro";
import { getCrystalizerImages, imageUrlFor, type CrystalizerImage } from "@/lib/Sanity";

let images: CrystalizerImage[] = [];
try {
  images = await getCrystalizerImages({ limit: 240 });
} catch (err) {
  console.warn('[crystallizer] getCrystalizerImages failed; falling back to runtime fetch only.', err);
  images = [];
}

const fmtDate = (iso?: string) => {
  if (!iso) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return String(iso);
  const y = String(d.getFullYear());
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
};
---

<Page title="Crystallizer" showSplash={false} showLogo={false}>
  <main slot="content" class="wrap">
    <section
      id="fs"
      class="fs"
      aria-hidden="false"
      role="dialog"
      aria-label="Crystallizer gallery"
    >
      <div class="fs-ui">
        <button class="mode-btn" type="button" title="ALL / GALLERY (Esc)">ALL</button>
        <div class="fs-hint">F: fullscreen / Esc: ALL⇄GALLERY / Space: pause</div>
        <div class="fs-meta">
          <span class="fs-count">{images.length} items</span>
          <span class="fs-speed"></span>
        </div>
      </div>

      <a class="make-crystal" href="/crystallizer/make/">MAKE CRYSTAL!</a>

      <div class="fs-info" aria-live="polite">
        <div class="fs-info-date"></div>
        <div class="fs-info-msg"></div>
        <div class="fs-info-name"></div>
      </div>

      <div class="fs-stage" aria-hidden="true">
        <div class="fs-track" id="fs-track">
          <div class="fs-loading">Loading…</div>
        </div>
      </div>

      <div class="all-view" aria-hidden="true">
        <section class="all-grid" aria-label="All items">
          {images.map((item) => {
            const imgUrl = item.image ? imageUrlFor(item.image).width(900).quality(80).auto("format").url() : "";
            const date = item.date || item.createdAt;
            const title = item.title || item.externalId || "(untitled)";
            return (
              <article class="card">
                <div class="img" data-url={imgUrl}>
                  {imgUrl ? <img src={imgUrl} alt={title} loading="lazy" /> : <div class="ph">no image</div>}
                  <div class="body">
                    {item.externalId && <span>#{item.externalId}</span>}
                    {date && <span>{fmtDate(date)}</span>}
                    {item.name && <span>{item.name}</span>}
                    {item.message && <span>{item.message}</span>}
                  </div>
                </div>
              </article>
            );
          })}
        </section>
      </div>
    </section>
  </main>
</Page>

<script type="module">
  const fsEl = document.getElementById('fs');
  const fsTrackEl = document.getElementById('fs-track');
  const fsCountEl = document.querySelector('.fs-count');
  const fsSpeedEl = document.querySelector('.fs-speed');

  const modeBtn = document.querySelector('.mode-btn');
  const allGridEl = document.querySelector('.all-grid');

  const fsInfoEl = document.querySelector('.fs-info');
  const fsInfoDateEl = document.querySelector('.fs-info-date');
  const fsInfoNameEl = document.querySelector('.fs-info-name');
  const fsInfoMsgEl = document.querySelector('.fs-info-msg');

  const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

  const fmtDate = (iso) => {
    if (!iso) return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return String(iso);
    const y = String(d.getFullYear());
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${dd}`;
  };

  let mode = 'gallery'; // 'gallery' | 'all'

  function setMode(next) {
    mode = next;
    document.documentElement.classList.toggle('is-all', mode === 'all');
    if (modeBtn) modeBtn.textContent = mode === 'all' ? 'GALLERY' : 'ALL';
  }

  function toggleMode() {
    setMode(mode === 'all' ? 'gallery' : 'all');
  }

  async function enterFullscreenIfPossible() {
    if (!fsEl) return;
    try {
      if (!document.fullscreenElement && fsEl.requestFullscreen) {
        await fsEl.requestFullscreen();
      }
    } catch {
      // ignore
    }
  }

  function toggleBrowserFullscreen() {
    if (!fsEl) return;
    if (!document.fullscreenElement) enterFullscreenIfPossible();
    else document.exitFullscreen?.().catch(() => {});
  }

  function syncFullscreenClass() {
    document.documentElement.classList.toggle('is-fullscreen', !!document.fullscreenElement);
  }

  document.addEventListener('fullscreenchange', syncFullscreenClass);
  syncFullscreenClass();

  if (modeBtn) modeBtn.addEventListener('click', () => toggleMode());

  // -----------------
  // Filmstrip
  // -----------------
  let paused = false;
  let speed = prefersReducedMotion ? 0 : 70; // px/sec
  const minSpeed = prefersReducedMotion ? 0 : 60;
  let offset = 0;
  let lastTs = 0;
  let cycleWidth = 0;
  let rafId = 0;
  let itemEls = [];
  let focusLastTs = 0;

  let cycleResizeObserver = null;
  let cycleMeasureRafId = 0;

  function stopCycleWidthTracking() {
    if (cycleResizeObserver) {
      try {
        cycleResizeObserver.disconnect();
      } catch {
        // ignore
      }
      cycleResizeObserver = null;
    }
    if (cycleMeasureRafId) {
      window.cancelAnimationFrame(cycleMeasureRafId);
      cycleMeasureRafId = 0;
    }
  }

  function measureCycleWidth(groupEl) {
    if (!groupEl) return 0;
    const rectW = groupEl.getBoundingClientRect?.().width || 0;
    const scrollW = groupEl.scrollWidth || 0;
    const w = Math.max(rectW, scrollW);
    // When images are not loaded yet, widths can be 0. Avoid locking cycleWidth to ~0.
    return w > 20 ? w : 0;
  }

  function updateCycleWidthFrom(groupEl) {
    const w = measureCycleWidth(groupEl);
    if (!w) return false;
    cycleWidth = Math.max(1, w);
    return true;
  }

  function startCycleWidthTracking(groupEl) {
    stopCycleWidthTracking();
    if (!groupEl) return;

    // Measure now / next frame.
    updateCycleWidthFrom(groupEl);
    cycleMeasureRafId = window.requestAnimationFrame(() => {
      cycleMeasureRafId = 0;
      updateCycleWidthFrom(groupEl);
      updateFocusInfo();
    });

    // Track size changes as images load.
    if (window.ResizeObserver) {
      cycleResizeObserver = new ResizeObserver(() => {
        // Throttle to animation frame.
        if (cycleMeasureRafId) return;
        cycleMeasureRafId = window.requestAnimationFrame(() => {
          cycleMeasureRafId = 0;
          updateCycleWidthFrom(groupEl);
        });
      });
      try {
        cycleResizeObserver.observe(groupEl);
      } catch {
        // ignore
      }
    }

    // Also listen to image load/error once; this helps in browsers where ResizeObserver
    // might not fire for intrinsic-size changes in time.
    const imgs = groupEl.querySelectorAll ? groupEl.querySelectorAll('img') : [];
    for (const img of imgs) {
      if (!img) continue;
      if (img.complete) {
        updateCycleWidthFrom(groupEl);
        continue;
      }
      img.addEventListener(
        'load',
        () => {
          updateCycleWidthFrom(groupEl);
        },
        { once: true },
      );
      img.addEventListener(
        'error',
        () => {
          updateCycleWidthFrom(groupEl);
        },
        { once: true },
      );
    }

    // Safety retry in case network is slow.
    window.setTimeout(() => {
      updateCycleWidthFrom(groupEl);
    }, 1200);
  }

  function setUi(itemsLen) {
    if (fsCountEl) fsCountEl.textContent = `${itemsLen} items`;
    if (fsSpeedEl) fsSpeedEl.textContent = `${Math.round(speed)}px/s`;
  }

  function readItemsFromAllDom() {
    const root = document.querySelector('.all-grid');
    const links = root ? root.querySelectorAll('.img') : [];
    const items = [];
    let i = 0;
    for (const a of links) {
      const href = a?.dataset?.url || a?.getAttribute?.('data-url') || '';
      if (!href || href === '#') continue;
      const img = a.querySelector('img');

      const spans = Array.from(a.querySelectorAll('.body span'))
        .map((el) => (el?.textContent || '').trim())
        .filter(Boolean);

      const externalIdText = spans.find((t) => t.startsWith('#')) || '';
      const dateText = spans.find((t) => /^\d{4}-\d{2}-\d{2}$/.test(t)) || '';
      const rest = spans.filter((t) => t !== externalIdText && t !== dateText);
      const nameText = rest[0] || '';
      const msgText = rest.slice(1).join(' ') || '';

      items.push({
        id: `dom-${i++}`,
        url: href,
        alt: img?.getAttribute('alt') || '(untitled)',
        date: dateText,
        name: nameText,
        message: msgText,
      });
    }
    return items;
  }

  // Parapara
  const PARAPARA_CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?#$%&*+-';
  const paraparaStates = new WeakMap();

  function stopParapara(el) {
    const s = paraparaStates.get(el);
    if (s?.rafId) window.cancelAnimationFrame(s.rafId);
    paraparaStates.delete(el);
  }

  function paraparaSetText(el, finalText, { duration = 260 } = {}) {
    if (!el) return;
    stopParapara(el);
    const final = String(finalText ?? '');

    if (prefersReducedMotion || final.length === 0) {
      el.textContent = final;
      return;
    }

    const start = performance.now();
    const state = { rafId: 0 };
    paraparaStates.set(el, state);

    const pick = () => PARAPARA_CHARS[(Math.random() * PARAPARA_CHARS.length) | 0];

    const frame = (ts) => {
      const t = clamp((ts - start) / duration, 0, 1);
      const reveal = Math.floor(final.length * t);
      let out = '';
      for (let i = 0; i < final.length; i++) {
        const c = final[i];
        if (i < reveal) out += c;
        else if (c === ' ') out += ' ';
        else out += pick();
      }
      el.textContent = out;

      if (t < 1) state.rafId = window.requestAnimationFrame(frame);
      else el.textContent = final;
    };

    state.rafId = window.requestAnimationFrame(frame);
  }

  let lastInfoKey = '';
  function setInfo(item) {
    if (!fsInfoEl) return;
    const date = String(item?.date || '').trim();
    const name = String(item?.name || '').trim();
    const message = String(item?.message || '').trim();
    const key = `${date}|${name}|${message}`;
    if (key === lastInfoKey) return;
    lastInfoKey = key;

    paraparaSetText(fsInfoDateEl, date || '—');
    paraparaSetText(fsInfoMsgEl, message || '');
    paraparaSetText(fsInfoNameEl, name || '—');
    fsInfoEl.classList.toggle('has-msg', !!message);
  }

  function makeItemEl(item) {
    const fig = document.createElement('figure');
    fig.className = 'fs-item';
    fig.dataset.url = String(item?.url || '');
    fig.dataset.date = String(item?.date || '');
    fig.dataset.name = String(item?.name || '');
    fig.dataset.message = String(item?.message || '');

    const img = document.createElement('img');
    img.className = 'fs-img';
    img.loading = 'lazy';
    img.decoding = 'async';
    img.alt = item?.alt || '';
    img.src = item?.url || '';

    fig.appendChild(img);
    // fig.addEventListener('click', () => {
    //   if (!item?.url) return;
    //   window.open(item.url, '_blank', 'noreferrer');
    // });
    return fig;
  }

  function renderFilmstrip(items) {
    if (!fsTrackEl) return;
    const safeItems = Array.isArray(items) ? items.filter((x) => x && x.url) : [];
    setUi(safeItems.length);
    setInfo(null);

    if (safeItems.length === 0) {
      fsTrackEl.innerHTML = '<div class="fs-loading">No images</div>';
      cycleWidth = 0;
      itemEls = [];
      stopCycleWidthTracking();
      return;
    }

    fsTrackEl.innerHTML = '';
    // Reset motion state on rerender so we don't keep stale transforms.
    offset = 0;
    lastTs = 0;
    fsTrackEl.style.transform = 'translate3d(0, 0, 0)';

    const g1 = document.createElement('div');
    g1.className = 'fs-group';
    for (const item of safeItems) g1.appendChild(makeItemEl(item));

    const g2 = document.createElement('div');
    g2.className = 'fs-group';
    for (const item of safeItems) g2.appendChild(makeItemEl(item));

    fsTrackEl.appendChild(g1);
    fsTrackEl.appendChild(g2);

    itemEls = Array.from(fsTrackEl.querySelectorAll('.fs-item'));
    focusLastTs = 0;

    cycleWidth = 0;
    startCycleWidthTracking(g1);
  }

  function updateFocusInfo() {
    const els = itemEls;
    if (!els || els.length === 0) return;

    const stageW = window.innerWidth || 1;
    const centerX = stageW * 0.5;

    let bestEl = null;
    let bestDist = Infinity;
    for (const el of els) {
      const r = el.getBoundingClientRect();
      if (r.right <= 0 || r.left >= stageW) continue;
      const cx = (r.left + r.right) * 0.5;
      const d = Math.abs(cx - centerX);
      if (d < bestDist) {
        bestDist = d;
        bestEl = el;
      }
    }
    if (!bestEl) return;
    setInfo({
      date: bestEl.dataset.date,
      name: bestEl.dataset.name,
      message: bestEl.dataset.message,
    });
  }

  function updateFocusInfoThrottled(ts) {
    if (ts - focusLastTs < 120) return;
    focusLastTs = ts;
    updateFocusInfo();
  }

  function tick(ts) {
    rafId = window.requestAnimationFrame(tick);
    if (mode !== 'gallery') return;
    if (!fsTrackEl) return;

    if (!lastTs) lastTs = ts;
    const dt = Math.min(0.05, Math.max(0, (ts - lastTs) / 1000));
    lastTs = ts;

    if (!paused && speed > 0 && cycleWidth > 0) {
      offset += dt * speed;
      if (offset >= cycleWidth) offset -= cycleWidth;
      fsTrackEl.style.transform = `translate3d(${-offset}px, 0, 0)`;
    }

    updateFocusInfoThrottled(ts);
  }

  // Initial render from SSR DOM
  renderFilmstrip(readItemsFromAllDom());
  setMode('gallery');
  if (!rafId) rafId = window.requestAnimationFrame(tick);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'f' || e.key === 'F') {
      e.preventDefault();
      toggleBrowserFullscreen();
      return;
    }

    if (e.key === 'Escape') {
      e.preventDefault();
      toggleMode();
      return;
    }

    if (mode !== 'gallery') return;

    if (e.key === ' ') {
      e.preventDefault();
      paused = !paused;
      return;
    }

    if (e.key === 'ArrowRight') {
      e.preventDefault();
      speed = clamp(speed + 10, minSpeed, 300);
      setUi(readItemsFromAllDom().length);
      return;
    }

    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      speed = clamp(speed - 10, minSpeed, 300);
      setUi(readItemsFromAllDom().length);
      return;
    }
  });

  // -----------------
  // Auto refresh
  // -----------------
  let lastSig = '';
  function signatureForApiItems(items) {
    const arr = Array.isArray(items) ? items : [];
    const top = arr
      .slice(0, 60)
      .map((x) => String(x?.externalId || x?.imageUrl || x?.createdAt || ''))
      .join('|');
    return `${arr.length}::${top}`;
  }

  async function refreshFromApi() {
    try {
      const res = await fetch(`/api/crystallizer/gallery?limit=240&t=${Date.now()}`, {
        cache: 'no-store',
        credentials: 'same-origin',
      });
      if (!res.ok) return;
      const json = await res.json();
      const items = Array.isArray(json?.items) ? json.items : [];
      if (items.length === 0) return;

      const sig = signatureForApiItems(items);
      if (sig === lastSig) return;
      lastSig = sig;

      // remember focus url
      let prevFocusUrl = '';
      if (mode === 'gallery' && itemEls?.length) {
        const stageW = window.innerWidth || 1;
        const centerX = stageW * 0.5;
        let bestEl = null;
        let bestDist = Infinity;
        for (const el of itemEls) {
          const r = el.getBoundingClientRect();
          if (r.right <= 0 || r.left >= stageW) continue;
          const cx = (r.left + r.right) * 0.5;
          const d = Math.abs(cx - centerX);
          if (d < bestDist) {
            bestDist = d;
            bestEl = el;
          }
        }
        prevFocusUrl = bestEl?.dataset?.url || '';
      }

      // render list
      if (!allGridEl) return;
      allGridEl.innerHTML = '';
      for (const item of items) {
        const imgUrlRaw = item?.imageUrl || '';
        const imgUrl = imgUrlRaw ? `${imgUrlRaw}?w=900&q=80&auto=format` : '';
        const date = item?.date || item?.createdAt || '';
        const title = item?.title || item?.externalId || '(untitled)';

        const article = document.createElement('article');
        article.className = 'card';

        const a = document.createElement('div');
        a.className = 'img';
        a.dataset.url = imgUrl || '';

        if (imgUrl) {
          const img = document.createElement('img');
          img.src = imgUrl;
          img.alt = title;
          img.loading = 'lazy';
          a.appendChild(img);
        } else {
          const ph = document.createElement('div');
          ph.className = 'ph';
          ph.textContent = 'no image';
          a.appendChild(ph);
        }

        const body = document.createElement('div');
        body.className = 'body';
        if (item?.externalId) {
          const sp = document.createElement('span');
          sp.textContent = `#${item.externalId}`;
          body.appendChild(sp);
        }
        if (date) {
          const sp = document.createElement('span');
          sp.textContent = fmtDate(date);
          body.appendChild(sp);
        }
        if (item?.name) {
          const sp = document.createElement('span');
          sp.textContent = String(item.name);
          body.appendChild(sp);
        }
        if (item?.message) {
          const sp = document.createElement('span');
          sp.textContent = String(item.message);
          body.appendChild(sp);
        }

        a.appendChild(body);
        article.appendChild(a);
        allGridEl.appendChild(article);
      }

      setUi(items.length);

      // rerender filmstrip
      const next = readItemsFromAllDom();
      renderFilmstrip(next);

      if (mode === 'gallery' && prevFocusUrl && fsTrackEl && cycleWidth > 0) {
        window.requestAnimationFrame(() => {
          const el = fsTrackEl.querySelector(`.fs-item[data-url="${CSS.escape(prevFocusUrl)}"]`);
          if (!el) return;
          const r = el.getBoundingClientRect();
          const cx = (r.left + r.right) * 0.5;
          const desired = (window.innerWidth || 1) * 0.5;
          const delta = cx - desired;
          offset = (offset + delta) % cycleWidth;
          if (offset < 0) offset += cycleWidth;
          fsTrackEl.style.transform = `translate3d(${-offset}px, 0, 0)`;
        });
      }
    } catch {
      // ignore
    }
  }

  function startAutoRefresh() {
    const intervalMs = 30_000;
    window.setInterval(() => {
      if (document.visibilityState !== 'visible') return;
      refreshFromApi();
    }, intervalMs);

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') refreshFromApi();
    });

    // first refresh
    window.setTimeout(() => refreshFromApi(), 50);
  }

  startAutoRefresh();
</script>

<style lang="scss" is:global>
  @import url('https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap');

  .wrap {
    width: 100%;
    max-width: 1200px;
    position: absolute;
    top: 0;
    left: 0;
  }

  .fs {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: #000;
    color: #fff;
    overflow: hidden;
  }

  .fs-ui {
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    z-index: 3;
    font-family: "Space Mono", monospace;
  }

  .mode-btn {
    font-size: 10px;
    letter-spacing: 0.08em;
    border: 1px solid rgba(255, 255, 255, 0.32);
    background: rgba(0, 0, 0, 0.25);
    color: #fff;
    padding: 6px 10px;
    cursor: pointer;
    backdrop-filter: blur(10px);
  }

  .fs-hint {
    font-size: 10px;
    opacity: 0.75;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .fs-meta {
    display: flex;
    gap: 10px;
    align-items: baseline;
    font-size: 10px;
    opacity: 0.8;
    pointer-events: none;
  }

  .make-crystal {
    position: absolute;
    right: 12px;
    bottom: 12px;
    z-index: 3;
    font-family: "Space Mono", monospace;
    font-size: 14px;
    letter-spacing: 0.08em;
    background: rgba(0, 0, 0, 0.25);
    color: #000;
    padding: 20px 42px;
    text-decoration: none;
    backdrop-filter: blur(10px);
    background-color: #d4ff00;
    border-radius: 4px;
    @include mq(sp) {
        text-align: center;
        width: calc(100% - 24px);
    }
  }

  .fs-info {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate3d(-50%, -50%, 0);
    z-index: 2;
    width: min(720px, calc(100vw - 32px));
    text-align: center;
    font-family: "Space Mono", "Zen Kaku Gothic New", "Noto Sans JP", system-ui, -apple-system,
      BlinkMacSystemFont, sans-serif;
    color: rgba(255, 255, 255, 1);
    pointer-events: none;
    mix-blend-mode: difference;
  }

  .fs-info > * {
    position: relative;
  }

  .fs-info-date {
    font-size: 13px;
    letter-spacing: 0.04em;
    opacity: 0.78;
  }

  .fs-info-name {
    margin-top: 12px;
    font-size: 18px;
    letter-spacing: 0.02em;
    opacity: 0.82;
  }

  .fs-info-msg {
    margin-top: 12px;
    font-size: 64px;
    font-weight: 800;
    line-height: 1.5;
    opacity: 0.95;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .fs-info:not(.has-msg) .fs-info-msg {
    display: none;
  }

  .fs-stage {
    position: absolute;
    inset: 0;
    overflow: hidden;
    display: grid;
    place-items: center start;
  }

  .fs-track {
    width: max-content;
    display: flex;
    align-items: center;
    will-change: transform;
    transform: translate3d(0, 0, 0);
    padding: 0 6vw;
  }

  .fs-group {
    display: flex;
    align-items: center;
  }

  .fs-item {
    height: 100vh;
    flex: 0 0 auto;
    margin: 0;
    line-height: 0;
  }

  .fs-img {
    height: 100vh;
    width: auto;
    max-width: 96vw;
    object-fit: contain;
    display: block;
    user-select: none;
    -webkit-user-drag: none;
    background: #000;
    image-rendering: pixelated;
  }

  .fs-loading {
    font-family: "Space Mono", monospace;
    font-size: 12px;
    opacity: 0.75;
    padding-left: 6vw;
  }

  .all-view {
    position: absolute;
    inset: 0;
    overflow: auto;
    // padding: 56px 10px 10px;
    padding: 0px;
    display: none;
  }

  .all-grid {
    display: grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: 0;
  }

  @media (max-width: 640px) {
    .all-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  .img {
    position: relative;
    display: block;

    img {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
      background-color: #000;
      image-rendering: pixelated;
    }
  }

  .ph {
    width: 100%;
    height: 100%;
    display: grid;
    place-items: center;
    font-size: 11px;
    opacity: 0.6;
  }

  .img .body {
    position: absolute;
    bottom: 0;
  }

  .body span {
    display: block;
    font-size: 10px;
    line-height: 1.4;
    font-family: "Space Mono", "Zen Kaku Gothic New", monospace;
    color: #fff;
  }

  html.is-all .fs-stage,
  html.is-all .fs-info {
    display: none;
  }

  html.is-all .all-view {
    display: block;
  }

  html.is-fullscreen .fs-ui,
  html.is-fullscreen .make-crystal {
    display: none;
  }
</style>
